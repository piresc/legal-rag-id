services:
  # Vector Database Service
  vector-db:
    build:
      context: .
      dockerfile: docker/Dockerfile.vector_db
    container_name: legal-rag-vector-db
    environment:
      - DATABASE_PATH=/app/data/vectors/vector_database.pkl
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - USE_SEMANTIC_SEARCH=${USE_SEMANTIC_SEARCH:-true}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/1
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    ports:
      - "8003:8000"
    networks:
      - legal-rag-ai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

  # Cache Service
  cache-service:
    image: redis:7-alpine
    container_name: legal-rag-ai-cache
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_password}
    volumes:
      - ai_redis_data:/data
    ports:
      - "6381:6379"  # Different port to avoid conflicts
    networks:
      - legal-rag-ai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # RAG Service
  rag-service:
    build:
      context: .
      dockerfile: docker/Dockerfile.rag
    container_name: legal-rag-rag-service
    environment:
      - VECTOR_DB_URL=http://vector-db:8000
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@cache-service:6379/1
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEFAULT_PROVIDER=${DEFAULT_PROVIDER:-deepseek}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-deepseek-reasoner}
      - MAX_TOKENS=${MAX_TOKENS:-1000}
      - TEMPERATURE=${TEMPERATURE:-0.7}
      - CACHE_TTL=${CACHE_TTL:-3600}
      - TOP_K_DEFAULT=${TOP_K_DEFAULT:-5}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    depends_on:
      vector-db:
        condition: service_healthy
      cache-service:
        condition: service_healthy
    networks:
      - legal-rag-ai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

  # LLM Service
  llm-service:
    build:
      context: .
      dockerfile: docker/Dockerfile.llm
    container_name: legal-rag-llm-service
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@cache-service:6379/1
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      # API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      # LLM Configuration
      - MAX_TOKENS=${MAX_TOKENS:-1000}
      - TEMPERATURE=${TEMPERATURE:-0.7}
      - TIMEOUT=${TIMEOUT:-30}
    volumes:
      - ./logs:/app/logs
    depends_on:
      - cache-service
    networks:
      - legal-rag-ai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8002/health')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

  # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.api_gateway
    container_name: legal-rag-api-gateway
    environment:
      - RAG_SERVICE_URL=http://rag-service:8001
      - LLM_SERVICE_URL=http://llm-service:8002
      - VECTOR_DB_URL=http://vector-db:8000
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@cache-service:6379/1
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      # API Configuration
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=${API_PORT:-8000}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-100}
      - RATE_LIMIT_PERIOD=${RATE_LIMIT_PERIOD:-60}
      # Authentication
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config
    ports:
      - "8000:8000"
    depends_on:
      - rag-service
      - llm-service
      - vector-db
    networks:
      - legal-rag-ai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

  # Load Balancer
  nginx:
    image: nginx:alpine
    container_name: legal-rag-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - api-gateway
      - web-frontend
    networks:
      - legal-rag-ai-network
    restart: unless-stopped
    profiles:
      - production

  # Service Discovery (Optional)
  consul:
    image: consul:latest
    container_name: legal-rag-consul
    command: agent -server -bootstrap -ui -client=0.0.0.0
    volumes:
      - consul_data:/consul/data
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    networks:
      - legal-rag-ai-network
    restart: unless-stopped
    profiles:
      - discovery

  # Message Queue (Optional for async processing)
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: legal-rag-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-admin}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD:-admin}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - legal-rag-ai-network
    restart: unless-stopped
    profiles:
      - queue

volumes:
  ai_redis_data:
    driver: local
  consul_data:
    driver: local
  rabbitmq_data:
    driver: local

networks:
  legal-rag-ai-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16